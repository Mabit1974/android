From aa83bfd0d8adf8ee176bc532fad5e74058099f14 Mon Sep 17 00:00:00 2001
From: milaq <micha.laqua@gmail.com>
Date: Sun, 24 Mar 2013 12:29:10 +0100
Subject: [PATCH] Added driver_cmd function to nl80211 driver based on
 https://github.com/CoolRunnerII/android_external_wpa_supplicant_6/commit/77f32c0687cee36a6211d4cf5eaaa9bf226ceb1d

---
 wpa_supplicant/Android.mk                   |   15 ++++++++++
 wpa_supplicant/src/drivers/driver_nl80211.c |   38 +++++++++++++++++++++++++++
 2 files changed, 53 insertions(+), 0 deletions(-)

diff --git a/wpa_supplicant/Android.mk b/wpa_supplicant/Android.mk
index b767907..9e7bad6 100644
--- a/wpa_supplicant/Android.mk
+++ b/wpa_supplicant/Android.mk
@@ -43,7 +43,11 @@ L_CFLAGS += -DWPA_IGNORE_CONFIG_ERRORS
 L_CFLAGS += -DWPA_UNICODE_SSID
 
 # OpenSSL is configured without engines on Android
+ifeq ($(BOARD_NEEDS_NL80211_DRIVER_CMD),true)
+L_CFLAGS += -DNL80211_DRIVER_CMD -DOPENSSL_NO_ENGINE -lnl
+else
 L_CFLAGS += -DOPENSSL_NO_ENGINE
+endif
 
 INCLUDES = $(LOCAL_PATH)
 INCLUDES += $(LOCAL_PATH)/src
@@ -63,6 +67,9 @@ INCLUDES += $(LOCAL_PATH)/src/utils
 INCLUDES += $(LOCAL_PATH)/src/wps
 INCLUDES += external/openssl/include
 INCLUDES += frameworks/base/cmds/keystore
+ifeq ($(BOARD_NEEDS_NL80211_DRIVER_CMD),true)
+INCLUDES += external/libnl/include
+endif
 
 OBJS = config.c
 OBJS += src/utils/common.c
@@ -157,6 +164,10 @@ ifdef CONFIG_DRIVER_NL80211
 L_CFLAGS += -DCONFIG_DRIVER_NL80211
 OBJS_d += src/drivers/driver_nl80211.c
 LIBS += -lnl
+ifeq ($(BOARD_NEEDS_NL80211_DRIVER_CMD),true)
+LIBS_W += -lnl
+LIBS_p += -lnl
+endif
 ifdef CONFIG_CLIENT_MLME
 OBJS_d += src/drivers/radiotap.c
 endif
@@ -1131,7 +1142,11 @@ endif
 ifneq ($(BOARD_WPA_SUPPLICANT_PRIVATE_LIB),)
 LOCAL_STATIC_LIBRARIES += $(BOARD_WPA_SUPPLICANT_PRIVATE_LIB)
 endif
+ifeq ($(BOARD_NEEDS_NL80211_DRIVER_CMD),true)
+LOCAL_SHARED_LIBRARIES := libc libcutils libcrypto libssl libnl
+else
 LOCAL_SHARED_LIBRARIES := libc libcutils libcrypto libssl
+endif
 LOCAL_CFLAGS := $(L_CFLAGS)
 LOCAL_SRC_FILES := $(OBJS)
 LOCAL_C_INCLUDES := $(INCLUDES)
diff --git a/wpa_supplicant/src/drivers/driver_nl80211.c b/wpa_supplicant/src/drivers/driver_nl80211.c
index 9ab6d17..8aa3b9a 100644
--- a/wpa_supplicant/src/drivers/driver_nl80211.c
+++ b/wpa_supplicant/src/drivers/driver_nl80211.c
@@ -92,6 +92,41 @@ static int wpa_driver_nl80211_get_range(void *priv);
 static void
 wpa_driver_nl80211_finish_drv_init(struct wpa_driver_nl80211_data *drv);
 
+#ifdef NL80211_DRIVER_CMD
+#define MAX_DRV_CMD_SIZE 32
+
+static int wpa_driver_nl80211_driver_cmd(void *priv, char *cmd, char *buf,
+					 size_t buf_len)
+{
+   struct wpa_driver_nl80211_data *drv = priv;
+   int ret = -1;
+   char buffer[128];
+   char *str;
+   FILE *fp;
+   float link, level;
+   static int link_dbg=100;
+   if (os_strcasecmp(cmd, "RSSI-APPROX") == 0) {
+		os_strncpy(cmd, "RSSI", 10);
+   }
+	if ((os_strcasecmp(cmd, "RSSI") == 0)){
+	   fp= fopen("/proc/net/wireless","r");
+	   if( fp == NULL )
+         {
+		   wpa_printf(MSG_ERROR, "Could not open /proc/net/wireless");
+		   return -1;
+	   }
+	   while(fgets(buffer,128, fp)){
+		//wpa_printf(MSG_DEBUG, "read: %s %s", buffer, drv->ifname);
+		if ((str = os_strstr(buffer, drv->ifname))!=NULL){
+			sscanf(buffer +  14, "%f %f", &link, &level);
+			wpa_printf(MSG_DEBUG, "found wlan0: %d %f", link, level);
+		}
+	   }
+	   ret = sprintf(buf,"dummy rssi %d", (int)level);
+	}
+	return ret;
+}
+#endif
 
 /* nl80211 code */
 static int ack_handler(struct nl_msg *msg, void *arg)
@@ -2763,4 +2798,7 @@ const struct wpa_driver_ops wpa_driver_nl80211_ops = {
 	.mlme_add_sta = wpa_driver_nl80211_mlme_add_sta,
 	.mlme_remove_sta = wpa_driver_nl80211_mlme_remove_sta,
 #endif /* CONFIG_CLIENT_MLME */
+#ifdef NL80211_DRIVER_CMD
+	.driver_cmd = wpa_driver_nl80211_driver_cmd,
+#endif
 };
-- 
1.7.9

