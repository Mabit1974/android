From df8a3a2651181fe330c3683c1b60aef6adf32e9c Mon Sep 17 00:00:00 2001
From: milaq <micha.laqua@gmail.com>
Date: Sun, 19 Jul 2015 14:03:45 +0200
Subject: [PATCH] Add support for ignoring exchange server policy (2/2)

Some of us don't like the policies enforced by some exchange server configurations or the inconveniences that come with it (safe lockscreen, etc.).
So make it possible to ignore any policies pushed by the exchange server.

Based on the "ExchangeBypassXposed" module by Shantanu Goel.

This also requires the app to be signed with platform keys.
---
 Android.mk                                            | 1 -
 src/com/android/exchange/adapter/ProvisionParser.java | 3 +++
 2 files changed, 3 insertions(+), 1 deletion(-)

diff --git a/Android.mk b/Android.mk
index 662c52f..4c30a36 100644
--- a/Android.mk
+++ b/Android.mk
@@ -40,7 +40,6 @@ LOCAL_PACKAGE_NAME := Exchange2
 LOCAL_OVERRIDES_PACKAGES := Exchange
 
 LOCAL_PROGUARD_FLAG_FILES := proguard.flags
-LOCAL_SDK_VERSION := 19
 
 LOCAL_EMMA_COVERAGE_FILTER += +com.android.exchange.*
 
diff --git a/src/com/android/exchange/adapter/ProvisionParser.java b/src/com/android/exchange/adapter/ProvisionParser.java
index 4888b8d..14cf775 100644
--- a/src/com/android/exchange/adapter/ProvisionParser.java
+++ b/src/com/android/exchange/adapter/ProvisionParser.java
@@ -19,6 +19,7 @@ import android.app.admin.DevicePolicyManager;
 import android.content.Context;
 import android.content.res.Resources;
 import android.os.Environment;
+import android.os.SystemProperties;
 import android.support.v4.content.ContextCompat;
 
 import com.android.emailcommon.provider.Policy;
@@ -75,6 +76,8 @@ public class ProvisionParser extends Parser {
     }
 
     public boolean hasSupportablePolicySet() {
+        if (SystemProperties.getBoolean("persist.exchange.nopolicy", false))
+            return true;
         return (mPolicy != null) && mIsSupportable;
     }
 
-- 
2.4.6

